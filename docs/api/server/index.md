---
title: SillyTavern-NewAge 服务器架构概述
---

# SillyTavern-NewAge 服务器架构概述

SillyTavern-NewAge 服务器是一个基于 Node.js、Express 和 Socket.IO 构建的实时通信服务器，旨在为 SillyTavern 及其扩展提供一个灵活、可扩展且安全的后端。

## 1. 核心技术

* **Node.js:**  服务器端 JavaScript 运行环境。
* **Express:**  Web 应用程序框架，用于处理 HTTP 请求和路由。
* **Socket.IO:**  实时通信库，实现服务器与客户端之间的双向、低延迟通信。
* **bcryptjs:** 密码哈希库，用于保护客户端密钥和密码。
* **winston:**  日志记录库，用于记录服务器操作和错误。
* **uuid:**  UUID 生成库，用于生成唯一的客户端密钥。
* **lodash:**  实用工具库，提供了一系列方便的函数。
* **dayjs:** 日期时间处理库。

## 2. 设计思想

* **模块化:**  服务器代码被组织成多个模块，每个模块负责特定的功能 (例如，密钥管理、房间管理、日志记录等)，提高了代码的可维护性和可重用性。
* **命名空间 (Namespaces):**  Socket.IO 的命名空间用于隔离不同的功能和客户端类型，使服务器能够处理多种类型的客户端和请求，同时保持代码的组织性。
* **事件驱动:**  服务器使用事件驱动的编程模型，通过监听和触发事件来处理客户端请求和服务器操作。
* **安全性:**  服务器采取了多种安全措施，包括：
  * 客户端身份验证 (使用密钥)。
  * 密码哈希 (使用 bcrypt)。
  * 路径安全检查 (防止路径遍历攻击)。
  * 可信客户端列表 (限制对某些功能的访问)。
  * 网络安全模式 (限制对某些 API 的访问)。
* **可扩展性:**  服务器的设计允许通过添加新的命名空间、模块和事件处理程序来轻松扩展其功能。
* **灵活性:**  客户端可以通过函数调用机制与服务器进行交互，动态加载静态资源，实现高度的灵活性。
* **易用性：** 服务器提供了简洁的API，且为许多操作提供了默认的实现。

## 3. 架构

### 3.1. 整体架构

服务器采用典型的客户端-服务器架构，其中：

* **客户端:**  可以是 SillyTavern 扩展、Web 应用程序、移动应用程序或其他任何支持 Socket.IO 的客户端。
* **服务器:**  处理客户端连接、身份验证、消息路由、函数调用、房间管理、日志记录和其他核心功能。

```mermaid
graph LR
    subgraph Clients
        A[SillyTavern 扩展] -->|Socket.IO| C(SillyTavern-NewAge 服务器)
        B[Web/移动应用] -->|Socket.IO| C
        Monitor[监控前端] -->|Socket.IO| C
    end
    subgraph Server[SillyTavern-NewAge 服务器]
        C --> D(Express)
        C --> E[Socket.IO 命名空间]
        E --> F[/auth]
        E --> G[/llm]
        E --> H[/function_call]
        E --> I[/rooms]
        E --> J[/clients]
        E --> K[/sillytavern]
        E --> L[/debug]
        E --> M[/ (默认)]
        D --> N[静态资源]
    end

    style Server fill:#f9f,stroke:#333,stroke-width:2px
```

### 3.2. 命名空间 (Namespaces)

服务器使用 Socket.IO 的命名空间来组织不同的功能和客户端类型：

* **`/` (默认):**  主要用于监控客户端 (`monitor`)。
* **`/auth`:**  处理客户端身份验证、密钥获取。
* **`/llm`:**  处理 LLM (大型语言模型) 请求的路由和转发。
* **`/function_call`:**  处理客户端发起的函数调用请求。
* **`/rooms`:**  处理房间管理 (创建、删除、加入、离开等)。
* **`/clients`:**  处理客户端管理 (获取客户端列表、密钥等)。
* **`/sillytavern`:**  用于服务器与 SillyTavern 扩展之间的通信 (身份标识)。
* **`/debug`:** 提供调试相关的功能 (切换调试模式、读取日志)。

### 3.3. 模块

服务器代码被组织成以下几个主要模块：

* **`server.js`:**  服务器的主入口文件，负责：
  * 初始化 Express 和 Socket.IO。
  * 加载服务器设置。
  * 处理客户端连接和身份验证。
  * 设置事件监听器。
  * 路由请求到相应的命名空间和处理程序。
* **`lib/`:** 包含一些库函数和常量定义。
  * **`constants.js`:**  定义常量 (命名空间、消息类型等)。
  * **`non_stream.js`**:  自定义模块，处理非流式 Socket.IO 事件。
  * **`stream.js`**:  自定义模块，处理流式 Socket.IO 事件。
  * **`uuid/uuid.js`**: 自定义模块, 生成UUID。
* **`dist/`:** 包含服务器的核心逻辑。
  * **`debug.js`:**  处理调试模式的启用和禁用。
  * **`function_call.js`:**  提供可供远程调用的函数 (例如，添加静态资源、读写文件)。
  * **`Keys.js`:**  管理客户端密钥 (生成、存储、验证、移除)。
  * **`logger.js`:**  日志记录模块。
  * **`Rooms.js`:**  房间管理模块。

### 3.4. 核心概念

* **客户端 ID (`clientId`):**  每个客户端的唯一标识符。
* **客户端类型 (`clientType`):**  客户端的类型 (例如，`'extension'`、`'monitor'`、`'SillyTavern'` 等)。
* **密钥 (`key`):**  用于客户端身份验证的字符串。
* **房间 (`room`):**  Socket.IO 的一个概念，用于将客户端分组，以便向特定组的客户端广播消息。
* **可信客户端 (`trustedClients`):**  一个集合，包含受信任的普通客户端的 `clientId`。
* **可信 SillyTavern (`trustedSillyTaverns`):**  一个集合，包含受信任的 SillyTavern 扩展的 `clientId`。
* **函数调用：** 允许客户端通过`/function_call`命名空间来调用服务端的特定函数。
* **静态资源：** 服务器可以通过`addStaticResources`函数来提供静态资源 (HTML, CSS, JavaScript, 图像等)。

## 4. 工作流程 (示例：LLM 请求)

1. 客户端 (例如 Web 应用程序) 连接到服务器 (默认命名空间或 `/llm` 命名空间)。
2. 客户端进行身份验证 (通过 `/auth` 命名空间)。
3. 客户端发送 LLM 请求 (通过 `/llm` 命名空间)，指定目标 SillyTavern 扩展的 `clientId` 和请求数据。
4. 服务器验证客户端是否有权限向目标 SillyTavern 发送请求。
5. 如果目标 SillyTavern 在线，服务器将请求转发给它。
6. SillyTavern 处理请求并将响应发送回服务器。
7. 服务器将响应转发回原始客户端。
8. 客户端可以监听流式事件，来获取流式数据。

## 5. 安全性

服务器采取了以下安全措施：

* **身份验证:**  客户端必须提供有效的 `clientId` 和 `key` 才能连接到服务器。
* **密钥管理:**  客户端密钥使用 bcrypt 进行哈希存储，确保密钥的安全性。
* **权限控制:**  服务器维护可信客户端列表，并限制对某些 API (例如房间管理) 的访问。
* **路径安全:**  `sanitizePath` 函数用于防止路径遍历攻击，确保客户端只能访问服务器允许的文件。
* **网络安全模式:** 限制了部分API的访问。

## 6. 总结

SillyTavern-NewAge 服务器提供了一个强大、灵活且安全的基础设施，用于构建实时、交互式的 SillyTavern 扩展和应用程序。其模块化设计、命名空间的使用、事件驱动模型和内置的安全机制使其成为一个可靠且可扩展的解决方案。
